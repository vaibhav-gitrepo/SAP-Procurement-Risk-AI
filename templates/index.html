<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>SAP PO RISK Auditor - Sandbox </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0f172a; --text: #f8fafc; --card: rgba(30,41,59,0.8); }
        [data-theme="light"] { --bg: #f8fafc; --text: #1e293b; --card: #ffffff; }
        body { background: var(--bg); color: var(--text); transition: 0.3s; font-family: 'Segoe UI', sans-serif; }
        .glass-card { background: var(--card); border-radius: 12px; padding: 25px; border: 1px solid rgba(128,128,128,0.2); }
        
        /* High Visibility Inputs: Force white background and black text regardless of theme */
        .high-vis-input { 
            background-color: #ffffff !important; 
            color: #000000 !important; 
            border: 2px solid #0070f2 !important;
            font-weight: bold;
            height: 45px;
        }
        .high-vis-input:focus { box-shadow: 0 0 10px rgba(0,112,242,0.5); }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark px-4 border-bottom border-primary mb-4">
        <span class="navbar-brand fw-bold">SAP SANDBOX AUDITOR</span>
        <div class="d-flex gap-3">
            <button onclick="toggleHighRiskFilter()" id="filterBtn" class="btn btn-outline-danger btn-sm">ðŸš¨ FILTER HIGH RISK</button>
            <a href="/api/export-csv" class="btn btn-success btn-sm fw-bold">ðŸ“¥ DOWNLOAD REPORT</a>
            <button onclick="toggleTheme()" class="btn btn-outline-light btn-sm">THEME</button>
        </div>
    </nav>

    <div class="container">
        <div class="row g-4">
            <div class="col-lg-4">
                <div class="glass-card">
                    <h6 class="fw-bold mb-3">Manual Prediction Simulator</h6>
                    <div class="mb-3">
                        <label class="small fw-bold text-uppercase">Currency Selection</label>
                        <select id="curr" class="form-select high-vis-input">
                            <option value="USD">USD ($) - US Dollar</option>
                            <option value="INR">INR (â‚¹) - Indian Rupee</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold text-uppercase">Enter Amount</label>
                        <input type="number" id="amt" class="form-control high-vis-input" placeholder="e.g. 15000">
                    </div>
                    <div class="mb-4">
                        <label class="small fw-bold">VENDOR SCORE: <span id="vVal" class="text-primary">80</span>%</label>
                        <input type="range" id="vscore" class="form-range" oninput="vVal.innerText=this.value">
                    </div>
                    <button onclick="runPredict()" class="btn btn-primary w-100 fw-bold">PREDICT RISK</button>
                    <div id="manualRes" class="mt-3 p-3 rounded text-center d-none fw-bold"></div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="glass-card" style="height: 420px;">
                    <h6 class="fw-bold">Risk Trend (Latest SAP Sandbox POs)</h6>
                    <canvas id="riskChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="glass-card mb-5">
                    <h6 class="fw-bold mb-3">ðŸ“‹ GLOBAL AUDIT TRAIL</h6>
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-hover align-middle">
                            <thead class="small text-muted sticky-top bg-dark">
                                <tr><th>DATE</th><th>PO SOURCE</th><th>AMT (USD)</th><th>SCORE</th><th>STATUS</th><th>AI ANALYSIS</th></tr>
                            </thead>
                            <tbody id="auditBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let highRiskOnly = false;
        let myChart;

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            document.documentElement.setAttribute('data-theme', current === 'dark' ? 'light' : 'dark');
        }

        function toggleHighRiskFilter() {
            highRiskOnly = !highRiskOnly;
            const btn = document.getElementById('filterBtn');
            btn.innerText = highRiskOnly ? "âŒ SHOW ALL" : "ðŸš¨ FILTER HIGH RISK";
            btn.className = highRiskOnly ? "btn btn-danger btn-sm" : "btn btn-outline-danger btn-sm";
            renderTable();
        }

        async function updateData() {
            const res = await fetch('/api/auto-feed');
            allData = await res.json();
            renderTable();
            updateChart();
        }

        function renderTable() {
            const displayData = highRiskOnly ? allData.filter(d => d.risk_label === 1) : allData;
            document.getElementById('auditBody').innerHTML = displayData.map(row => `
                <tr class="${row.risk_label ? 'table-danger' : ''}">
                    <td class="small">${new Date(row.created_at).toLocaleTimeString()}</td>
                    <td><span class="badge ${row.po_number === 'MANUAL_CHK' ? 'bg-secondary' : 'bg-primary'}">${row.po_number}</span></td>
                    <td>$${row.amount_usd.toLocaleString()}</td>
                    <td>${row.vendor_score}%</td>
                    <td><span class="badge bg-${row.risk_label ? 'danger' : 'success'}">${row.risk_label ? 'HIGH' : 'LOW'}</span></td>
                    <td class="small">${row.suggestion}</td>
                </tr>
            `).join('');
        }

        function updateChart() {
            const ctx = document.getElementById('riskChart').getContext('2d');
            const recent = allData.slice(0, 10).reverse();
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: recent.map(d => d.po_number),
                    datasets: [{ 
                        label: 'Risk Level (0=Low, 1=High)', 
                        data: recent.map(d => d.risk_label), 
                        borderColor: '#0070f2', 
                        backgroundColor: 'rgba(0, 112, 242, 0.2)',
                        fill: true,
                        tension: 0.4 
                    }]
                },
                options: { maintainAspectRatio: false }
            });
        }

        async function runPredict() {
            const r = await fetch('/predict', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({
                    amount: document.getElementById('amt').value, 
                    currency: document.getElementById('curr').value, 
                    vendor_score: document.getElementById('vscore').value
                }) 
            });
            const d = await r.json();
            const res = document.getElementById('manualRes');
            res.className = `mt-3 p-3 rounded text-center bg-${d.status} text-white d-block`;
            res.innerHTML = `RESULT: ${d.risk} (${d.confidence})`;
            updateData();
        }

        window.onload = updateData;
        setInterval(updateData, 30000); // Auto-refresh UI every 30 seconds
    </script>
</body>
</html>