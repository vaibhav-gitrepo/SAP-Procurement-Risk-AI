<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>SAP PO RISK Auditor - Sandbox </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0f172a; --text: #f8fafc; --card: rgba(30,41,59,0.8); }
        [data-theme="light"] { --bg: #f8fafc; --text: #1e293b; --card: #ffffff; }
        body { background: var(--bg); color: var(--text); transition: 0.3s; font-family: 'Segoe UI', sans-serif; }
        .glass-card { background: var(--card); border-radius: 12px; padding: 25px; border: 1px solid rgba(128,128,128,0.2); }
        
        .high-vis-input { 
            background-color: #ffffff !important; 
            color: #000000 !important; 
            border: 2px solid #0070f2 !important;
            font-weight: bold;
            height: 45px;
        }
        .high-vis-input:focus { box-shadow: 0 0 10px rgba(0,112,242,0.5); }
        .table-responsive { border-radius: 8px; }
        .sticky-top { z-index: 10; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark px-4 border-bottom border-primary mb-4">
        <span class="navbar-brand fw-bold">SAP SANDBOX AUDITOR</span>
        <div class="d-flex gap-3">
            <button onclick="toggleHighRiskFilter()" id="filterBtn" class="btn btn-outline-danger btn-sm">ðŸš¨ FILTER HIGH RISK</button>
            <a href="/api/export-csv" class="btn btn-success btn-sm fw-bold">ðŸ“¥ DOWNLOAD REPORT</a>
            <button onclick="toggleTheme()" class="btn btn-outline-light btn-sm">THEME</button>
        </div>
    </nav>

    <div class="container">
        <div class="row g-4">
            <div class="col-lg-4">
                <div class="glass-card">
                    <h6 class="fw-bold mb-3">Manual Prediction Simulator</h6>
                    <div class="mb-3">
                        <label class="small fw-bold text-uppercase">Currency Selection</label>
                        <select id="curr" class="form-select high-vis-input">
                            <option value="USD">USD ($) - US Dollar</option>
                            <option value="INR">INR (â‚¹) - Indian Rupee</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold text-uppercase">Enter Amount</label>
                        <input type="number" id="amt" class="form-control high-vis-input" placeholder="e.g. 15000">
                    </div>
                    <div class="mb-4">
                        <label class="small fw-bold">VENDOR SCORE: <span id="vVal" class="text-primary">80</span>%</label>
                        <input type="range" id="vscore" class="form-range" oninput="vVal.innerText=this.value">
                    </div>
                    <button onclick="runPredict()" class="btn btn-primary w-100 fw-bold">PREDICT RISK</button>
                    <div id="manualRes" class="mt-3 p-3 rounded text-center d-none fw-bold"></div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="glass-card" style="height: 420px;">
                    <h6 class="fw-bold">Risk Trend (Latest SAP Sandbox POs)</h6>
                    <canvas id="riskChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="glass-card mb-5">
                    <h6 class="fw-bold mb-3">ðŸ“‹ GLOBAL AUDIT TRAIL</h6>
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-hover align-middle">
                            <thead class="small text-muted sticky-top bg-dark">
                                <tr>
                                    <th>DATE & TIME</th>
                                    <th>PO SOURCE</th>
                                    <th>AMT (USD)</th>
                                    <th>SCORE</th>
                                    <th>STATUS</th>
                                    <th>AI ANALYSIS & REASONING</th>
                                </tr>
                            </thead>
                            <tbody id="auditBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let highRiskOnly = false;
        let myChart;

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            document.documentElement.setAttribute('data-theme', current === 'dark' ? 'light' : 'dark');
        }

        function toggleHighRiskFilter() {
            highRiskOnly = !highRiskOnly;
            const btn = document.getElementById('filterBtn');
            btn.innerText = highRiskOnly ? "âŒ SHOW ALL" : "ðŸš¨ FILTER HIGH RISK";
            btn.className = highRiskOnly ? "btn btn-danger btn-sm" : "btn btn-outline-danger btn-sm";
            renderTable();
        }

        async function updateData() {
            try {
                const res = await fetch('/api/auto-feed');
                allData = await res.json();
                renderTable();
                updateChart();
            } catch (e) { console.error("Data fetch failed", e); }
        }

        function renderTable() {
            const displayData = highRiskOnly ? allData.filter(d => d.risk_label === 1) : allData;
            document.getElementById('auditBody').innerHTML = displayData.map(row => {
                // 1. Exact Date Formatting
                const d = new Date(row.created_at);
                const dateStr = d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                const timeStr = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                // 2. PO Source & AI Reasoning Logic
                let sourceHTML = "";
                let aiReasoning = row.suggestion;

                if (row.po_number === 'MANUAL_CHK') {
                    sourceHTML = `<span class="badge bg-secondary">User Manual Check</span>`;
                    aiReasoning = `<strong>[SIMULATION]</strong> User-initiated test. ${row.suggestion}`;
                } else if (row.po_number.includes('SAP') || row.po_number.startsWith('10')) {
                    sourceHTML = `<span class="badge bg-primary">SAP ODATA (Sandbox)</span><br><small class="text-muted">Ref: ${row.po_number}</small>`;
                    aiReasoning = `<strong>[LIVE SAP]</strong> Production data sync. ${row.suggestion}`;
                } else {
                    sourceHTML = `<span class="badge bg-info text-dark">Randomly Generated</span>`;
                    aiReasoning = `<strong>[STRESS TEST]</strong> Synthetic data entry. ${row.suggestion}`;
                }

                return `
                <tr class="${row.risk_label ? 'table-danger' : ''}">
                    <td class="small">
                        <div class="fw-bold">${dateStr}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">${timeStr}</div>
                    </td>
                    <td>${sourceHTML}</td>
                    <td class="fw-bold">$${row.amount_usd.toLocaleString()}</td>
                    <td>
                        <div class="progress" style="height: 10px; width: 60px;">
                            <div class="progress-bar" style="width: ${row.vendor_score}%"></div>
                        </div>
                        <small>${row.vendor_score}%</small>
                    </td>
                    <td><span class="badge bg-${row.risk_label ? 'danger' : 'success'}">${row.risk_label ? 'HIGH RISK' : 'LOW RISK'}</span></td>
                    <td class="small" style="max-width: 250px;">${aiReasoning}</td>
                </tr>
                `;
            }).join('');
        }

        function updateChart() {
            const ctx = document.getElementById('riskChart').getContext('2d');
            const recent = allData.slice(0, 15).reverse();
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: recent.map(d => d.po_number === 'MANUAL_CHK' ? 'Manual' : d.po_number),
                    datasets: [{ 
                        label: 'Risk Score History', 
                        data: recent.map(d => d.risk_label), 
                        borderColor: '#0070f2', 
                        backgroundColor: 'rgba(0, 112, 242, 0.1)',
                        fill: true,
                        tension: 0.3 
                    }]
                },
                options: { 
                    maintainAspectRatio: false,
                    scales: { y: { min: 0, max: 1, ticks: { stepSize: 1 } } }
                }
            });
        }

        async function runPredict() {
            const amt = document.getElementById('amt').value;
            if(!amt) return alert("Please enter an amount");

            const r = await fetch('/predict', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({
                    amount: amt, 
                    currency: document.getElementById('curr').value, 
                    vendor_score: document.getElementById('vscore').value
                }) 
            });
            const d = await r.json();
            const res = document.getElementById('manualRes');
            res.className = `mt-3 p-3 rounded text-center bg-${d.status} text-white d-block`;
            res.innerHTML = `RESULT: ${d.risk.toUpperCase()} (${d.confidence} Confidence)`;
            updateData();
        }

        window.onload = updateData;
        setInterval(updateData, 30000);
    </script>
</body>
</html>